#!/usr/bin/env sh
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.
clear
set -e
unset CDPATH

echo "   ___        _      _     ____           _            
  / _ \ _   _(_) ___| | __/ ___|___ _ __ | |_ ___ _ __ 
 | | | | | | | |/ __| |/ / |   / _ \ '_ \| __/ _ \ '__|
 | |_| | |_| | | (__|   <| |___  __/ | | | |_  __/ |   
  \__\_\\__,_|_|\___|_|\_\\____\___|_| |_|\__\___|_|   "
echo
warn() {
  echo "$*"
}

die() {
  echo
  echo "$*"
  echo
  exit 1
}

parse_env_properties_file() {
  # grep "${1}" "${ENV_PROPERTIES}" | sed -E 's/^[^=]*=(.*)$/\1/'
  grep "${1}" "${ENV_PROPERTIES}"|cut -d'=' -f2-
}

parse_product_properties_file() {
  # grep "${1}" "${PRODUCT_PROPERTIES}" | sed -E 's/^[^=]*=(.*)$/\1/'
  grep "${1}" "${PRODUCT_PROPERTIES}"|cut -d'=' -f2-
}


MY_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

# echo "$MY_ROOT"

# TODO Extend to additional environments
ENV_PROPERTIES="${MY_ROOT}/../local.properties"
PRODUCTS_AVAILABLE=$(parse_env_properties_file 'available.product.codes')

# echo "$ENV_PROPERTIES"
if [ -z "$1" ]; then
  die "Please supply one of these product types: $PRODUCTS_AVAILABLE"
elif [ -z "$2" ]; then
  die "Please supply a valid task"
fi

PRODUCT_CODE="$1.path"
PRODUCT_DIR=$(parse_env_properties_file "$PRODUCT_CODE")
GW_PRODUCT=${PRODUCT_CODE%.*}

echo  Launching "$GW_PRODUCT" "$2"
echo "======================================================================"
echo
# echo "$PRODUCT_DIR"

# Validate the path exists with the passes product code
if [ ! -d "$PRODUCT_DIR" ]; then
  die "Please supply one of the available product types and ensure the directory 
structure in the properties file is proper"
fi

# Retrieve the product major version in order to set the JDK and launch command
PRODUCT_PROPERTIES="${PRODUCT_DIR}modules/configuration/product.properties"
PRODUCT_MAJORVERSION=$(parse_product_properties_file 'product.majorversion')
PRODUCT_PATCHVERSION=$(parse_product_properties_file 'product.patchversion')

# echo "$PRODUCT_PROPERTIES"
# echo "$PRODUCT_MAJORVERSION"
# echo "$PRODUCT_PATCHVERSION"

# Set the JDK version based on the product
if [ "$PRODUCT_MAJORVERSION" == "10" ] && [ "$PRODUCT_PATCHVERSION" == "2" ]; then
  JAVA_PROP="java11.path"
  launcher="./gwb"
elif [ "$PRODUCT_MAJORVERSION" == "8" ] ; then
  JAVA_PROP="java17.path"
  launcher="bin/gw'${PRODUCT_CODE}'"
else
  JAVA_PROP="java18.path"
  launcher="./gwb"
fi

JAVA_DIR="$(parse_env_properties_file "$JAVA_PROP")"
export JAVA_HOME=$JAVA_DIR

cd "$PRODUCT_DIR"

eval "$launcher" "$2" "$3" "$4"